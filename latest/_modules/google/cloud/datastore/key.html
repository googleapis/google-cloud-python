
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>google.cloud.datastore.key &#8212; google-cloud 18f6634 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for google.cloud.datastore.key</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2014 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Create / interact with Google Cloud Datastore keys.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">google.cloud.datastore_v1.proto</span> <span class="k">import</span> <span class="n">entity_pb2</span> <span class="k">as</span> <span class="n">_entity_pb2</span>

<span class="kn">from</span> <span class="nn">google.cloud._helpers</span> <span class="k">import</span> <span class="n">_to_bytes</span>
<span class="kn">from</span> <span class="nn">google.cloud.datastore</span> <span class="k">import</span> <span class="n">_app_engine_key_pb2</span>


<span class="n">_DATABASE_ID_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;Received non-empty database ID: </span><span class="si">{!r}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="s1">&#39;urlsafe strings are not expected to encode a Reference that &#39;</span>
    <span class="s1">&#39;contains a database ID.&#39;</span><span class="p">)</span>
<span class="n">_BAD_ELEMENT_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;At most one of ID and name can be set on an element. Received &#39;</span>
    <span class="s1">&#39;id = </span><span class="si">{!r}</span><span class="s1"> and name = </span><span class="si">{!r}</span><span class="s1">.&#39;</span><span class="p">)</span>
<span class="n">_EMPTY_ELEMENT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;Exactly one of ID and name must be set on an element. &#39;</span>
    <span class="s1">&#39;Encountered an element with neither set that was not the last &#39;</span>
    <span class="s1">&#39;element of a path.&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Key"><a class="viewcode-back" href="../../../../datastore/keys.html#google.cloud.datastore.key.Key">[docs]</a><span class="k">class</span> <span class="nc">Key</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An immutable representation of a datastore Key.</span>

<span class="sd">    .. testsetup:: key-ctor</span>

<span class="sd">       from google.cloud import datastore</span>

<span class="sd">       project = &#39;my-special-pony&#39;</span>
<span class="sd">       client = datastore.Client(project=project)</span>
<span class="sd">       Key = datastore.Key</span>

<span class="sd">       parent_key = client.key(&#39;Parent&#39;, &#39;foo&#39;)</span>

<span class="sd">    To create a basic key directly:</span>

<span class="sd">    .. doctest:: key-ctor</span>

<span class="sd">       &gt;&gt;&gt; Key(&#39;EntityKind&#39;, 1234, project=project)</span>
<span class="sd">       &lt;Key(&#39;EntityKind&#39;, 1234), project=...&gt;</span>
<span class="sd">       &gt;&gt;&gt; Key(&#39;EntityKind&#39;, &#39;foo&#39;, project=project)</span>
<span class="sd">       &lt;Key(&#39;EntityKind&#39;, &#39;foo&#39;), project=...&gt;</span>

<span class="sd">    Though typical usage comes via the</span>
<span class="sd">    :meth:`~google.cloud.datastore.client.Client.key` factory:</span>

<span class="sd">    .. doctest:: key-ctor</span>

<span class="sd">       &gt;&gt;&gt; client.key(&#39;EntityKind&#39;, 1234)</span>
<span class="sd">       &lt;Key(&#39;EntityKind&#39;, 1234), project=...&gt;</span>
<span class="sd">       &gt;&gt;&gt; client.key(&#39;EntityKind&#39;, &#39;foo&#39;)</span>
<span class="sd">       &lt;Key(&#39;EntityKind&#39;, &#39;foo&#39;), project=...&gt;</span>

<span class="sd">    To create a key with a parent:</span>

<span class="sd">    .. doctest:: key-ctor</span>

<span class="sd">       &gt;&gt;&gt; client.key(&#39;Parent&#39;, &#39;foo&#39;, &#39;Child&#39;, 1234)</span>
<span class="sd">       &lt;Key(&#39;Parent&#39;, &#39;foo&#39;, &#39;Child&#39;, 1234), project=...&gt;</span>
<span class="sd">       &gt;&gt;&gt; client.key(&#39;Child&#39;, 1234, parent=parent_key)</span>
<span class="sd">       &lt;Key(&#39;Parent&#39;, &#39;foo&#39;, &#39;Child&#39;, 1234), project=...&gt;</span>

<span class="sd">    To create a partial key:</span>

<span class="sd">    .. doctest:: key-ctor</span>

<span class="sd">       &gt;&gt;&gt; client.key(&#39;Parent&#39;, &#39;foo&#39;, &#39;Child&#39;)</span>
<span class="sd">       &lt;Key(&#39;Parent&#39;, &#39;foo&#39;, &#39;Child&#39;), project=...&gt;</span>

<span class="sd">    :type path_args: tuple of string and integer</span>
<span class="sd">    :param path_args: May represent a partial (odd length) or full (even</span>
<span class="sd">                      length) key path.</span>

<span class="sd">    :type kwargs: dict</span>
<span class="sd">    :param kwargs: Keyword arguments to be passed in.</span>

<span class="sd">    Accepted keyword arguments are</span>

<span class="sd">    * namespace (string): A namespace identifier for the key.</span>
<span class="sd">    * project (string): The project associated with the key.</span>
<span class="sd">    * parent (:class:`~google.cloud.datastore.key.Key`): The parent of the key.</span>

<span class="sd">    The project argument is required unless it has been set implicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span> <span class="o">=</span> <span class="n">path_args</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">_validate_project</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="c1"># _flat_path, _parent, _namespace and _project must be set before</span>
        <span class="c1"># _combine_args() is called.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine_args</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two keys for equality.</span>

<span class="sd">        Incomplete keys never compare equal to any other key.</span>

<span class="sd">        Completed keys compare equal if they have the same path, project,</span>
<span class="sd">        and namespace.</span>

<span class="sd">        :rtype: bool</span>
<span class="sd">        :returns: True if the keys compare equal, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_partial</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">is_partial</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_path</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">flat_path</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">project</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare two keys for inequality.</span>

<span class="sd">        Incomplete keys never compare equal to any other key.</span>

<span class="sd">        Completed keys compare equal if they have the same path, project,</span>
<span class="sd">        and namespace.</span>

<span class="sd">        :rtype: bool</span>
<span class="sd">        :returns: False if the keys compare equal, else True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hash a keys for use in a dictionary lookp.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        :returns: a hash of the key&#39;s state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_path</span><span class="p">)</span> <span class="o">+</span>
                <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span> <span class="o">+</span>
                <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_path</span><span class="p">(</span><span class="n">path_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses positional arguments into key path with kinds and IDs.</span>

<span class="sd">        :type path_args: tuple</span>
<span class="sd">        :param path_args: A tuple from positional arguments. Should be</span>
<span class="sd">                          alternating list of kinds (string) and ID/name</span>
<span class="sd">                          parts (int or string).</span>

<span class="sd">        :rtype: :class:`list` of :class:`dict`</span>
<span class="sd">        :returns: A list of key parts with kind and ID or name set.</span>
<span class="sd">        :raises: :class:`ValueError` if there are no ``path_args``, if one of</span>
<span class="sd">                 the kinds is not a string or if one of the IDs/names is not</span>
<span class="sd">                 a string or an integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Key path must not be empty.&#39;</span><span class="p">)</span>

        <span class="n">kind_list</span> <span class="o">=</span> <span class="n">path_args</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">id_or_name_list</span> <span class="o">=</span> <span class="n">path_args</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Dummy sentinel value to pad incomplete key to even length path.</span>
        <span class="n">partial_ending</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_args</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">id_or_name_list</span> <span class="o">+=</span> <span class="p">(</span><span class="n">partial_ending</span><span class="p">,)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">id_or_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kind_list</span><span class="p">,</span> <span class="n">id_or_name_list</span><span class="p">):</span>
            <span class="n">curr_key_part</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">curr_key_part</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="s1">&#39;Kind was not a string.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">curr_key_part</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_or_name</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
                <span class="n">curr_key_part</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_or_name</span>
            <span class="k">elif</span> <span class="n">id_or_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">partial_ending</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span>
                                 <span class="s1">&#39;ID/name was not a string or integer.&#39;</span><span class="p">)</span>

            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_key_part</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_combine_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets protected data by combining raw data set from the constructor.</span>

<span class="sd">        If a ``_parent`` is set, updates the ``_flat_path`` and sets the</span>
<span class="sd">        ``_namespace`` and ``_project`` if not already set.</span>

<span class="sd">        :rtype: :class:`list` of :class:`dict`</span>
<span class="sd">        :returns: A list of key parts with kind and ID or name set.</span>
<span class="sd">        :raises: :class:`ValueError` if the parent key is not complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">child_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">is_partial</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Parent key must be complete.&#39;</span><span class="p">)</span>

            <span class="c1"># We know that _parent.path() will return a copy.</span>
            <span class="n">child_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="n">child_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">flat_path</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">namespace</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Child namespace must agree with parent</span><span class="se">\&#39;</span><span class="s1">s.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">namespace</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">project</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Child project must agree with parent</span><span class="se">\&#39;</span><span class="s1">s.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">project</span>

        <span class="k">return</span> <span class="n">child_path</span>

    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Duplicates the Key.</span>

<span class="sd">        Most attributes are simple types, so don&#39;t require copying. Other</span>
<span class="sd">        attributes like ``parent`` are long-lived and so we re-use them.</span>

<span class="sd">        :rtype: :class:`google.cloud.datastore.key.Key`</span>
<span class="sd">        :returns: A new ``Key`` instance with the same data as the current one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cloned_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_path</span><span class="p">,</span>
                                     <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                     <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>
        <span class="c1"># If the current parent has already been set, we re-use</span>
        <span class="c1"># the same instance</span>
        <span class="n">cloned_self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
        <span class="k">return</span> <span class="n">cloned_self</span>

<div class="viewcode-block" id="Key.completed_key"><a class="viewcode-back" href="../../../../datastore/keys.html#google.cloud.datastore.key.Key.completed_key">[docs]</a>    <span class="k">def</span> <span class="nf">completed_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_or_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates new key from existing partial key by adding final ID/name.</span>

<span class="sd">        :type id_or_name: str or integer</span>
<span class="sd">        :param id_or_name: ID or name to be added to the key.</span>

<span class="sd">        :rtype: :class:`google.cloud.datastore.key.Key`</span>
<span class="sd">        :returns: A new ``Key`` instance with the same data as the current one</span>
<span class="sd">                  and an extra ID or name added.</span>
<span class="sd">        :raises: :class:`ValueError` if the current key is not partial or if</span>
<span class="sd">                 ``id_or_name`` is not a string or integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_partial</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only a partial key can be completed.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">id_or_name_key</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
            <span class="n">id_or_name_key</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">id_or_name</span><span class="p">,</span>
                             <span class="s1">&#39;ID/name was not a string or integer.&#39;</span><span class="p">)</span>

        <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">new_key</span><span class="o">.</span><span class="n">_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">id_or_name_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_or_name</span>
        <span class="n">new_key</span><span class="o">.</span><span class="n">_flat_path</span> <span class="o">+=</span> <span class="p">(</span><span class="n">id_or_name</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">new_key</span></div>

<div class="viewcode-block" id="Key.to_protobuf"><a class="viewcode-back" href="../../../../datastore/keys.html#google.cloud.datastore.key.Key.to_protobuf">[docs]</a>    <span class="k">def</span> <span class="nf">to_protobuf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a protobuf corresponding to the key.</span>

<span class="sd">        :rtype: :class:`.entity_pb2.Key`</span>
<span class="sd">        :returns: The protobuf representing the key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_entity_pb2</span><span class="o">.</span><span class="n">Key</span><span class="p">()</span>
        <span class="n">key</span><span class="o">.</span><span class="n">partition_id</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
            <span class="n">key</span><span class="o">.</span><span class="n">partition_id</span><span class="o">.</span><span class="n">namespace_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;kind&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="Key.to_legacy_urlsafe"><a class="viewcode-back" href="../../../../datastore/keys.html#google.cloud.datastore.key.Key.to_legacy_urlsafe">[docs]</a>    <span class="k">def</span> <span class="nf">to_legacy_urlsafe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location_prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert to a base64 encode urlsafe string for App Engine.</span>

<span class="sd">        This is intended to work with the &quot;legacy&quot; representation of a</span>
<span class="sd">        datastore &quot;Key&quot; used within Google App Engine (a so-called</span>
<span class="sd">        &quot;Reference&quot;). The returned string can be used as the ``urlsafe``</span>
<span class="sd">        argument to ``ndb.Key(urlsafe=...)``. The base64 encoded values</span>
<span class="sd">        will have padding removed.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The string returned by ``to_legacy_urlsafe`` is equivalent, but</span>
<span class="sd">            not identical, to the string returned by ``ndb``. The location</span>
<span class="sd">            prefix may need to be specified to obtain identical urlsafe</span>
<span class="sd">            keys.</span>

<span class="sd">        :type location_prefix: str</span>
<span class="sd">        :param location_prefix: The location prefix of an App Engine project</span>
<span class="sd">                                ID. Often this value is &#39;s~&#39;, but may also be</span>
<span class="sd">                                &#39;e~&#39;, or other location prefixes currently</span>
<span class="sd">                                unknown.</span>

<span class="sd">        :rtype: bytes</span>
<span class="sd">        :returns: A bytestring containing the key encoded as URL-safe base64.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">location_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">project_id</span> <span class="o">=</span> <span class="n">location_prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>

        <span class="n">reference</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
            <span class="n">app</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">_to_legacy_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">),</span>  <span class="c1"># Avoid the copy.</span>
            <span class="n">name_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">raw_bytes</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;=&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Key.from_legacy_urlsafe"><a class="viewcode-back" href="../../../../datastore/keys.html#google.cloud.datastore.key.Key.from_legacy_urlsafe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_legacy_urlsafe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">urlsafe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert urlsafe string to :class:`~google.cloud.datastore.key.Key`.</span>

<span class="sd">        This is intended to work with the &quot;legacy&quot; representation of a</span>
<span class="sd">        datastore &quot;Key&quot; used within Google App Engine (a so-called</span>
<span class="sd">        &quot;Reference&quot;). This assumes that ``urlsafe`` was created within an App</span>
<span class="sd">        Engine app via something like ``ndb.Key(...).urlsafe()``.</span>

<span class="sd">        :type urlsafe: bytes or unicode</span>
<span class="sd">        :param urlsafe: The base64 encoded (ASCII) string corresponding to a</span>
<span class="sd">                        datastore &quot;Key&quot; / &quot;Reference&quot;.</span>

<span class="sd">        :rtype: :class:`~google.cloud.datastore.key.Key`.</span>
<span class="sd">        :returns: The key corresponding to ``urlsafe``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">urlsafe</span> <span class="o">=</span> <span class="n">_to_bytes</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">urlsafe</span> <span class="o">+=</span> <span class="n">padding</span>
        <span class="n">raw_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">urlsafe</span><span class="p">)</span>

        <span class="n">reference</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Reference</span><span class="p">()</span>
        <span class="n">reference</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span>

        <span class="n">project</span> <span class="o">=</span> <span class="n">_clean_app</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">_get_empty</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">name_space</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">_check_database_id</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">database_id</span><span class="p">)</span>
        <span class="n">flat_path</span> <span class="o">=</span> <span class="n">_get_flat_path</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">flat_path</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Boolean indicating if the key has an ID (or name).</span>

<span class="sd">        :rtype: bool</span>
<span class="sd">        :returns: ``True`` if the last element of the key&#39;s path does not have</span>
<span class="sd">                  an ``id`` or a ``name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_or_name</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Namespace getter.</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        :returns: The namespace of the current key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Path getter.</span>

<span class="sd">        Returns a copy so that the key remains immutable.</span>

<span class="sd">        :rtype: :class:`list` of :class:`dict`</span>
<span class="sd">        :returns: The (key) path of the current key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">flat_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Getter for the key path as a tuple.</span>

<span class="sd">        :rtype: tuple of string and integer</span>
<span class="sd">        :returns: The tuple of elements in the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kind getter. Based on the last element of path.</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        :returns: The kind of the current key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ID getter. Based on the last element of path.</span>

<span class="sd">        :rtype: int</span>
<span class="sd">        :returns: The (integer) ID of the key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Name getter. Based on the last element of path.</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        :returns: The (string) name of the key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id_or_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Getter. Based on the last element of path.</span>

<span class="sd">        :rtype: int (if ``id``) or string (if ``name``)</span>
<span class="sd">        :returns: The last element of the key&#39;s path if it is either an ``id``</span>
<span class="sd">                  or a ``name``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Project getter.</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        :returns: The key&#39;s project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>

    <span class="k">def</span> <span class="nf">_make_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a parent key for the current path.</span>

<span class="sd">        Extracts all but the last element in the key path and creates a new</span>
<span class="sd">        key, while still matching the namespace and the project.</span>

<span class="sd">        :rtype: :class:`google.cloud.datastore.key.Key` or :class:`NoneType`</span>
<span class="sd">        :returns: A new ``Key`` instance, whose path consists of all but the</span>
<span class="sd">                  last element of current path. If the current key has only</span>
<span class="sd">                  one path element, returns ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_partial</span><span class="p">:</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent_args</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">*</span><span class="n">parent_args</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                  <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The parent of the current key.</span>

<span class="sd">        :rtype: :class:`google.cloud.datastore.key.Key` or :class:`NoneType`</span>
<span class="sd">        :returns: A new ``Key`` instance, whose path consists of all but the</span>
<span class="sd">                  last element of current path. If the current key has only</span>
<span class="sd">                  one path element, returns ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_parent</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Key</span><span class="si">%s</span><span class="s1">, project=</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flat_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_validate_project</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure the project is set appropriately.</span>

<span class="sd">    If ``parent`` is passed, skip the test (it will be checked / fixed up</span>
<span class="sd">    later).</span>

<span class="sd">    If ``project`` is unset, attempt to infer the project from the environment.</span>

<span class="sd">    :type project: str</span>
<span class="sd">    :param project: A project.</span>

<span class="sd">    :type parent: :class:`google.cloud.datastore.key.Key`</span>
<span class="sd">    :param parent: (Optional) The parent of the key or ``None``.</span>

<span class="sd">    :rtype: str</span>
<span class="sd">    :returns: The ``project`` passed in, or implied from the environment.</span>
<span class="sd">    :raises: :class:`ValueError` if ``project`` is ``None`` and no project</span>
<span class="sd">             can be inferred from the parent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A Key must have a project set.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">project</span>


<span class="k">def</span> <span class="nf">_clean_app</span><span class="p">(</span><span class="n">app_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean a legacy (i.e. from App Engine) app string.</span>

<span class="sd">    :type app_str: str</span>
<span class="sd">    :param app_str: The ``app`` value stored in a &quot;Reference&quot; pb.</span>

<span class="sd">    :rtype: str</span>
<span class="sd">    :returns: The cleaned value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">app_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_empty</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">empty_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a protobuf field is &quot;empty&quot;.</span>

<span class="sd">    :type value: object</span>
<span class="sd">    :param value: A basic field from a protobuf.</span>

<span class="sd">    :type empty_value: object</span>
<span class="sd">    :param empty_value: The &quot;empty&quot; value for the same type as</span>
<span class="sd">                        ``value``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">empty_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_check_database_id</span><span class="p">(</span><span class="n">database_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure a &quot;Reference&quot; database ID is empty.</span>

<span class="sd">    :type database_id: unicode</span>
<span class="sd">    :param database_id: The ``database_id`` field from a &quot;Reference&quot; protobuf.</span>

<span class="sd">    :raises: :exc:`ValueError` if the ``database_id`` is not empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">database_id</span> <span class="o">!=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_DATABASE_ID_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_id</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_id_or_name</span><span class="p">(</span><span class="n">flat_path</span><span class="p">,</span> <span class="n">element_pb</span><span class="p">,</span> <span class="n">empty_allowed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add the ID or name from an element to a list.</span>

<span class="sd">    :type flat_path: list</span>
<span class="sd">    :param flat_path: List of accumulated path parts.</span>

<span class="sd">    :type element_pb: :class:`._app_engine_key_pb2.Path.Element`</span>
<span class="sd">    :param element_pb: The element containing ID or name.</span>

<span class="sd">    :type empty_allowed: bool</span>
<span class="sd">    :param empty_allowed: Indicates if neither ID or name need be set. If</span>
<span class="sd">                          :data:`False`, then **exactly** one of them must be.</span>

<span class="sd">    :raises: :exc:`ValueError` if 0 or 2 of ID/name are set (unless</span>
<span class="sd">             ``empty_allowed=True`` and 0 are set).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">id_</span> <span class="o">=</span> <span class="n">element_pb</span><span class="o">.</span><span class="n">id</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">element_pb</span><span class="o">.</span><span class="n">name</span>
    <span class="c1"># NOTE: Below 0 and the empty string are the &quot;null&quot; values for their</span>
    <span class="c1">#       respective types, indicating that the value is unset.</span>
    <span class="k">if</span> <span class="n">id_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">empty_allowed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_EMPTY_ELEMENT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flat_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">flat_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_BAD_ELEMENT_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_flat_path</span><span class="p">(</span><span class="n">path_pb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a legacy &quot;Path&quot; protobuf to a flat path.</span>

<span class="sd">    For example</span>

<span class="sd">        Element {</span>
<span class="sd">          type: &quot;parent&quot;</span>
<span class="sd">          id: 59</span>
<span class="sd">        }</span>
<span class="sd">        Element {</span>
<span class="sd">          type: &quot;child&quot;</span>
<span class="sd">          name: &quot;naem&quot;</span>
<span class="sd">        }</span>

<span class="sd">    would convert to ``(&#39;parent&#39;, 59, &#39;child&#39;, &#39;naem&#39;)``.</span>

<span class="sd">    :type path_pb: :class:`._app_engine_key_pb2.Path`</span>
<span class="sd">    :param path_pb: Legacy protobuf &quot;Path&quot; object (from a &quot;Reference&quot;).</span>

<span class="sd">    :rtype: tuple</span>
<span class="sd">    :returns: The path parts from ``path_pb``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_elts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_pb</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="n">num_elts</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path_pb</span><span class="o">.</span><span class="n">element</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">_add_id_or_name</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">index</span> <span class="o">==</span> <span class="n">last_index</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_to_legacy_path</span><span class="p">(</span><span class="n">dict_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a tuple of ints and strings in a legacy &quot;Path&quot;.</span>

<span class="sd">    .. note:</span>

<span class="sd">        This assumes, but does not verify, that each entry in</span>
<span class="sd">        ``dict_path`` is valid (i.e. doesn&#39;t have more than one</span>
<span class="sd">        key out of &quot;name&quot; / &quot;id&quot;).</span>

<span class="sd">    :type dict_path: lsit</span>
<span class="sd">    :param dict_path: The &quot;structured&quot; path for a key, i.e. it</span>
<span class="sd">                      is a list of dictionaries, each of which has</span>
<span class="sd">                      &quot;kind&quot; and one of &quot;name&quot; / &quot;id&quot; as keys.</span>

<span class="sd">    :rtype: :class:`._app_engine_key_pb2.Path`</span>
<span class="sd">    :returns: The legacy path corresponding to ``dict_path``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">dict_path</span><span class="p">:</span>
        <span class="n">element_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">element_kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="n">element_kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="o">**</span><span class="n">element_kwargs</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_app_engine_key_pb2</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">google-cloud</a></h1>



<p class="blurb">Google Cloud Client Libraries for Python</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=GoogleCloudPlatform&repo=google-cloud-python&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../core/index.html">Core Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../asset/index.html">Asset Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../automl/index.html">AutoML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery/index.html">BigQuery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigquery_datatransfer/index.html">BigQuery Data-Transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bigtable/index.html">Bigtable</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../container/index.html">Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dataproc/index.html">Dataproc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../datastore/index.html">Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dlp/index.html">Data Loss Prevention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dns/index.html">DNS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../firestore/index.html">Firestore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../iot/index.html">IoT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../kms/index.html">Key Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../language/index.html">Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pubsub/index.html">PubSub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oslogin/index.html">OSLogin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redis/index.html">Redis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resource-manager/index.html">Resource Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../runtimeconfig/index.html">Python Client for Google Cloud RuntimeConfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../runtimeconfig/index.html#api-reference">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../securitycenter/index.html">Security Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../websecurityscanner/index.html">Security Scanner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../spanner/index.html">Spanner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../speech/index.html">Speech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage/index.html">Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tasks/index.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../texttospeech/index.html">Text-to-Speech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../translate/index.html">Translate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../vision/index.html">Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../videointelligence/index.html">Video Intelligence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../error-reporting/index.html">Stackdriver Error Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging/index.html">Stackdriver Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring/index.html">Stackdriver Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../trace/index.html">Stackdriver Trace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Release History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2014-2017, Google.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/GoogleCloudPlatform/google-cloud-python" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>