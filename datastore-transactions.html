<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Transactions &mdash; gcloud 0.3.0 documentation</title>
    
    <link rel="stylesheet" href="_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/normalize.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/github.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/js/vendor/modernizr-2.6.2.min.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="gcloud 0.3.0 documentation" href="index.html" />
    <link rel="next" title="Queries" href="datastore-queries.html" />
    <link rel="prev" title="Keys" href="datastore-keys.html" /> 
  </head>
  <body>
    <header class="page-header fixed" role="banner">
      <h1 class="logo">
        <a href="index.html" title="back to home">
          <img src="_static/images/logo.svg" alt="Google Cloud Platform" />
          <span class="gcloud">gcloud</span>
        </a>
      </h1>
      <nav class="main-nav">
        <div class="nav-current">Python</div>
        <ul class="menu">                    
          <li>
            <a href=" 
https://googlecloudplatform.github.io/gcloud-node" title="Node.js docs page">
              <img src="_static/images/icon-lang-nodejs.svg" alt="Node.js icon" class="menu-icon" />
              Node.js
            </a>
          </li>
          <li>
            <a href="#" title="Python docs page">
              <img src="_static/images/icon-lang-python.svg" alt="Python icon" class="menu-icon" />
              Python
            </a>
          </li>
        </ul>
      </nav><!-- end of .main-nav -->
    </header><!-- end of .page-header -->
    
      <article class="main lang-page" role="main">

      <header class="docs-header">
        <h1 class="page-title">Python</h1>

          <div class="versions">
            <span class="v-current">0.3.0</span>
            <!--
            <a href="versions.html" class="v-btn">
              <img src="_static/images/icon-arrow-bullet.svg" />
              See version History
            </a href="versions.html">
          </div><!-- end of .versions -->
      </header>
                
      <section class="content">
        
  <div class="section" id="module-gcloud.datastore.transaction">
<span id="transactions"></span><h1>Transactions<a class="headerlink" href="#module-gcloud.datastore.transaction" title="Permalink to this headline">#</a></h1>
<p>Create / interact with gcloud datastore transactions.</p>
<dl class="class">
<dt id="gcloud.datastore.transaction.Transaction">
<em class="property">class </em><tt class="descclassname">gcloud.datastore.transaction.</tt><tt class="descname">Transaction</tt><big>(</big><em>dataset_id=None</em>, <em>connection=None</em><big>)</big><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction" title="Permalink to this definition">#</a></dt>
<dd><p>Bases: <tt class="xref py py-class docutils literal"><span class="pre">object</span></tt></p>
<p>An abstraction representing datastore Transactions.</p>
<p>Transactions can be used to build up a bulk mutuation as well as
provide isolation.</p>
<p>For example, the following snippet of code will put the two <tt class="docutils literal"><span class="pre">save</span></tt>
operations (either <tt class="docutils literal"><span class="pre">insert_auto_id</span></tt> or <tt class="docutils literal"><span class="pre">upsert</span></tt>) into the same
mutation, and execute those within a transaction:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">gcloud</span> <span class="kn">import</span> <span class="n">datastore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">gcloud.datastore.transaction</span> <span class="kn">import</span> <span class="n">Transaction</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">datastore</span><span class="o">.</span><span class="n">set_default_connection</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">datastore</span><span class="o">.</span><span class="n">set_default_dataset_id</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">entity1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">entity2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>By default, the transaction is rolled back if the transaction block
exits with an error:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">do_some_work</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">raise</span> <span class="n">SomeException</span><span class="p">()</span>  <span class="c"># rolls back</span>
</pre></div>
</div>
<p>If the transaction block exists without an exception, it will commit
by default.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Inside a transaction, automatically assigned IDs for
entities will not be available at save time!  That means, if you
try:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">entity</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">entity</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">entity</span></tt> won&#8217;t have a complete Key until the transaction is
committed.</p>
<p>Once you exit the transaction (or call <tt class="docutils literal"><span class="pre">commit()</span></tt>), the
automatically generated ID will be assigned to the entity:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">entity</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">entity</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">is_partial</span>  <span class="c"># There is no ID on this key.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">is_partial</span>  <span class="c"># There *is* an ID.</span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If you&#8217;re using the automatically generated ID
functionality, it&#8217;s important that you only use
<a class="reference internal" href="datastore-entities.html#gcloud.datastore.entity.Entity.save" title="gcloud.datastore.entity.Entity.save"><tt class="xref py py-meth docutils literal"><span class="pre">gcloud.datastore.entity.Entity.save()</span></tt></a> rather than using
<a class="reference internal" href="datastore-api.html#gcloud.datastore.connection.Connection.save_entity" title="gcloud.datastore.connection.Connection.save_entity"><tt class="xref py py-meth docutils literal"><span class="pre">gcloud.datastore.connection.Connection.save_entity()</span></tt></a>
directly.</p>
<p class="last">If you mix the two, the results will have extra IDs generated and
it could jumble things up.</p>
</div>
<p>If you don&#8217;t want to use the context manager you can initialize a
transaction manually:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">transaction</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transaction</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">entity</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entity</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>For now, this library will enforce a rule of one transaction per
connection.  That is, If you want to work with two transactions at
the same time (for whatever reason), that must happen over two
separate <a class="reference internal" href="datastore-api.html#gcloud.datastore.connection.Connection" title="gcloud.datastore.connection.Connection"><tt class="xref py py-class docutils literal"><span class="pre">gcloud.datastore.connection.Connection</span></tt></a> s.</p>
<p>For example, this is perfectly valid:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">entity</span> <span class="o">=</span> <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">entity</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>However, this <strong>wouldn&#8217;t</strong> be acceptable:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Transaction</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">with</span> <span class="n">Transaction</span><span class="p">():</span>
<span class="gp">... </span>        <span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;Thing&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Technically, it looks like the Protobuf API supports this type of
pattern, however it makes the code particularly messy.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>dataset_id</strong> (<em>string</em>) &#8211; The ID of the dataset.</li>
<li><strong>connection</strong> (<a class="reference internal" href="datastore-api.html#gcloud.datastore.connection.Connection" title="gcloud.datastore.connection.Connection"><tt class="xref py py-class docutils literal"><span class="pre">gcloud.datastore.connection.Connection</span></tt></a>) &#8211; The connection used to connect to datastore.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Raises:</th><td class="field-body"><p class="first last"><tt class="xref py py-class docutils literal"><span class="pre">ValueError</span></tt> if either a connection or dataset ID
are not set.</p>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="gcloud.datastore.transaction.Transaction.add_auto_id_entity">
<tt class="descname">add_auto_id_entity</tt><big>(</big><em>entity</em><big>)</big><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.add_auto_id_entity"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.add_auto_id_entity" title="Permalink to this definition">#</a></dt>
<dd><p>Adds an entity to the list of entities to update with IDs.</p>
<p>When an entity has a partial key, calling <tt class="docutils literal"><span class="pre">save()</span></tt> adds an
insert_auto_id entry in the mutation.  In order to make sure we
update the Entity once the transaction is committed, we need to
keep track of which entities to update (and the order is
important).</p>
<p>When you call <tt class="docutils literal"><span class="pre">save()</span></tt> on an entity inside a transaction, if
the entity has a partial key, it adds itself to the list of
entities to be updated once the transaction is committed by
calling this method.</p>
</dd></dl>

<dl class="method">
<dt id="gcloud.datastore.transaction.Transaction.begin">
<tt class="descname">begin</tt><big>(</big><big>)</big><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.begin"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.begin" title="Permalink to this definition">#</a></dt>
<dd><p>Begins a transaction.</p>
<p>This method is called automatically when entering a with
statement, however it can be called explicitly if you don&#8217;t want
to use a context manager.</p>
</dd></dl>

<dl class="method">
<dt id="gcloud.datastore.transaction.Transaction.commit">
<tt class="descname">commit</tt><big>(</big><big>)</big><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.commit"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.commit" title="Permalink to this definition">#</a></dt>
<dd><p>Commits the transaction.</p>
<p>This is called automatically upon exiting a with statement,
however it can be called explicitly if you don&#8217;t want to use a
context manager.</p>
<p>This method has necessary side-effects:</p>
<ul class="simple">
<li>Sets the current connection&#8217;s transaction reference to None.</li>
<li>Sets the current transaction&#8217;s ID to None.</li>
<li>Updates paths for any keys that needed an automatically generated ID.</li>
</ul>
</dd></dl>

<dl class="attribute">
<dt id="gcloud.datastore.transaction.Transaction.connection">
<tt class="descname">connection</tt><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.connection"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.connection" title="Permalink to this definition">#</a></dt>
<dd><p>Getter for connection over which the transaction will run.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><a class="reference internal" href="datastore-api.html#gcloud.datastore.connection.Connection" title="gcloud.datastore.connection.Connection"><tt class="xref py py-class docutils literal"><span class="pre">gcloud.datastore.connection.Connection</span></tt></a></td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The connection over which the transaction will run.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="gcloud.datastore.transaction.Transaction.dataset_id">
<tt class="descname">dataset_id</tt><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.dataset_id"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.dataset_id" title="Permalink to this definition">#</a></dt>
<dd><p>Getter for dataset ID in which the transaction will run.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">string</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The dataset ID in which the transaction will run.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="gcloud.datastore.transaction.Transaction.id">
<tt class="descname">id</tt><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.id"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.id" title="Permalink to this definition">#</a></dt>
<dd><p>Getter for the transaction ID.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">string</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The ID of the current transaction.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="gcloud.datastore.transaction.Transaction.mutation">
<tt class="descname">mutation</tt><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.mutation"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.mutation" title="Permalink to this definition">#</a></dt>
<dd><p>Getter for the current mutation.</p>
<p>Every transaction is committed with a single Mutation
representing the &#8216;work&#8217; to be done as part of the transaction.
Inside a transaction, calling <tt class="docutils literal"><span class="pre">save()</span></tt> on an entity builds up
the mutation.  This getter returns the Mutation protobuf that
has been built-up so far.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><tt class="xref py py-class docutils literal"><span class="pre">gcloud.datastore.datastore_v1_pb2.Mutation</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">The Mutation protobuf to be sent in the commit request.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="gcloud.datastore.transaction.Transaction.rollback">
<tt class="descname">rollback</tt><big>(</big><big>)</big><a class="reference internal" href="_modules/gcloud/datastore/transaction.html#Transaction.rollback"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#gcloud.datastore.transaction.Transaction.rollback" title="Permalink to this definition">#</a></dt>
<dd><p>Rolls back the current transaction.</p>
<p>This method has necessary side-effects:</p>
<ul class="simple">
<li>Sets the current connection&#8217;s transaction reference to None.</li>
<li>Sets the current transaction&#8217;s ID to None.</li>
</ul>
</dd></dl>

</dd></dl>

</div>


      </section><!-- end of .content -->
      <nav class="side-nav">
        <ul><li><a href="index.html">gcloud</a></li></ul>
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="datastore-api.html">Datastore</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastore-entities.html">Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastore-keys.html">Keys</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastore-queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage-api.html">Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage-buckets.html">Buckets</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage-keys.html">Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage-acl.html">ACL</a></li>
</ul>

        <ul class="external-links">
          <li>
            <a href="https://github.com/GoogleCloudPlatform/gcloud-python/" title="Python on Github">
              <img src="_static/images/icon-link-github.svg" alt="Github icon" />
              Github
            </a>
          </li>
          <li>
            <a href="https://github.com/GoogleCloudPlatform/gcloud-python/issues" title="Python issues on Github">
              <img src="_static/images/icon-link-github.svg" alt="Github icon" />
              Issues
            </a>
          </li>
          <li>
            <a href="http://stackoverflow.com/questions/tagged/gcloud-python" title="gcloud on StackOverflow">
              <img src="_static/images/icon-link-stackoverflow.svg" alt="StackOverflow icon" />
              gcloud
            </a>
          </li>
          <li>
            <a href="https://pypi.python.org/pypi/gcloud" title="Python package manager">
              <img src="_static/images/icon-link-package-manager.svg" alt="Package Manager icon" />
              Package Manager
            </a>
          </li>
        </ul>
      </nav><!-- end of .side-nav -->
    </article><!-- end of .main -->

    <script src="_static/js/vendor/jquery-1.10.2.min.js"></script>
    <script src="_static/js/plugins.js"></script>
    <script src="_static/js/main.js"></script>
  
  </body>
</html>